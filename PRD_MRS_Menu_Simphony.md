## Title
PRD: Управление меню точек продаж в 1С:ERP 2.5 с интеграцией Simphony (OpenAPI)

## Context & Goals
- **Проблема и фон**
  - Типовой справочник `питМеню` не покрывает сценарии управления меню по конкретным точкам продаж и интеграции в Simphony. Нужен новый иерархический объект, управляемый по владельцу (`КассыККМ`), с прямой синхронизацией через OpenAPI.
- **Цели (Objectives)**
  1) Создать новый иерархический `Справочник.MRS_Меню` с владельцем `КассыККМ`, где группы соответствуют `FamilyGroup`.
  2) Обеспечить синхронизацию позиций меню с Simphony через REST API (индивидуально и пакетно).
  3) Загрузить и поддерживать в актуальном состоянии справочники: `Major Groups`, `Family Groups`, `Class Items` из Simphony.
  4) Реализовать логирование запросов/ответов и статусы синхронизации по каждой позиции меню.
  5) Предоставить пользователям удобные формы списка/элемента для управления меню своих точек продаж.
- **Не цели / Out of scope**
  - Модификация типового справочника `питМеню` и копирование его форм/обработок.
  - Ценообразование, акции/скидки, складской учет.
  - KT-2000/ЕГАИС операции (кроме классификации по `КлассМеню`).

## Assumptions
- `Family Group` — единые для всех точек продаж (глобальный справочник).
- `hierStrucId` для всех `КассыККМ` — всегда 1 (значение по умолчанию, не редактируется пользователем).
- В Simphony существуют и доступны через API все необходимые `Major Groups`, `Family Groups`, `Class Items`.
- Аутентификация Simphony — заголовки `X-User-Id`, `X-Correlation-Id`, `X-Request-Id`.
- Все новые объекты именуются с префиксом `MRS_`.

## Core functions (MoSCoW)
- **MUST**
  - `Справочник.MRS_Меню` (иерархический, владелец `КассыККМ`, группы соответствуют `FamilyGroup`).
  - Справочники: `MRS_МажорнаяГруппа`, `MRS_СемейнаяГруппа`, `MRS_КлассМеню`.
  - Интеграция с Simphony REST API: CRUD позиций меню; загрузка эталонных справочников.
  - `Регистр сведений.MRS_СтатусыСинхронизацииМеню`.
  - `Регистр сведений.MRS_ЛогИнтеграцииSimphony`.
  - Общие модули интеграции и логирования.
  - Формы списка и элемента для `MRS_Меню` с валидацией.
- **SHOULD**
  - Регламентная загрузка справочников из Simphony (1 раз/сутки).
  - Пакетная синхронизация позиций (`POST /menu-items`).
  - Обработка для массовых операций.
- **COULD**
  - Отчеты по синхронизации.
  - Расширенные настройки интеграции.

## Flows (Text-Only)
1) **Первоначальная настройка справочников**
   1. Администратор запускает обработку синхронизации справочников.
   2. Система вызывает `GET /referencedata/major-groups` → создает/обновляет `MRS_МажорнаяГруппа`.
   3. Система вызывает `GET /referencedata/family-groups` → создает/обновляет `MRS_СемейнаяГруппа` (глобально).
   4. Система вызывает `GET /referencedata/reportgroup` → создает/обновляет `MRS_КлассМеню`.
   5. Все операции логируются; ошибки фиксируются в логе с телами запросов/ответов.

2) **Создание группы меню**
   1. Пользователь открывает `MRS_Меню.ФормаСписка`, устанавливает отбор по своей `КассыККМ`.
   2. Команда «Создать группу»: создается элемент-Группа.
   3. Обязательные поля для группы: `Владелец=КассыККМ`, `СемейнаяГруппа` (из `MRS_СемейнаяГруппа`), `ЭтоГруппа=Истина`.
   4. Реквизиты позиций на форме группы скрыты (условное оформление).

3) **Создание позиции меню**
   1. Пользователь выбирает родительскую группу (с установленной `СемейнаяГруппа`) и команду «Создать».
   2. На форме элемента заполняет:
      - `Номенклатура` (обяз.) → `Наименование` по умолчанию = `Номенклатура.Наименование`.
      - `Единица хранения` (только просмотр, из `Номенклатура`).
      - `МажорнаяГруппа` (обяз.), `КлассМеню` (обяз.).
      - `СемейнаяГруппа` наследуется от родителя (только просмотр).
      - `Видимость` (Булево), `НомерВМеню` (`fileNum`, опционально).
      - `IDСтруктурыSimphony` (`hierStrucId`) = 1 (автоматически, недоступно для редактирования).
      - `НомерПозиции` (`stringNumberId`) генерируется по правилу (см. Data & Integrations).
   3. Ограничения:
      - Нельзя создавать позицию вне группы.
      - Без `МажорнаяГруппа`/`КлассМеню`/наследованной `СемейнаяГруппа` запись запрещена.
   4. При записи:
      - Создается запись в `MRS_СтатусыСинхронизацииМеню` со статусом «Создано».
      - По команде «Синхронизировать с Simphony»:
        - Статус → «ВОбработке».
        - Формируется JSON-представление.
        - Отправляется `PUT /menu-item`.
        - По ответу: 2xx → «Синхронизировано» (+IDы запросов); 4xx/5xx → «Ошибка» (+текст ошибки).
        - Во всех случаях пишется лог-запись с телами запроса/ответа и временем выполнения.

4) **Массовая синхронизация позиций**
   1. Пользователь выделяет несколько позиций в `MRS_Меню.ФормаСписка` (одна `КассыККМ`).
   2. Запускает «Синхронизировать выбранные» или соответствующую обработку.
   3. Система группирует позиции по `hierStrucId` (значение 1).
   4. Формируется пакетный запрос `POST /menu-items` (единый `hierStrucId=1`).
   5. По ответу статусы всех позиций обновляются, пишется общий лог с деталями неуспешных.

## Steps

1) Метаданные 1С (создать, все новые объекты — с префиксом `MRS_`)
- [x] Справочник `MRS_Меню` (иерархический; владелец `КассыККМ`): реквизиты по PRD, включая `НомерПозиции` (Строка(9)), `IDСтруктурыSimphony` (=1).
- [x] Справочник `MRS_МажорнаяГруппа` (НомерОбъекта, КатегорияПоДиапазону).
- [x] Справочник `MRS_СемейнаяГруппа` (глобальный; НомерОбъекта).
- [x] Справочник `MRS_КлассМеню` (НомерОбъекта).
- [x] Регистр сведений `MRS_СтатусыСинхронизацииМеню` (Измерение: ПозицияМеню; Ресурсы: Статус, ДатаОбновления, ТекстОшибки, IDЗапроса, IDКорреляции).
- [x] Регистр сведений `MRS_ЛогИнтеграцииSimphony` (Измерения/Ресурсы по PRD).
- [x] Перечисления `MRS_СтатусыСинхронизации`, `MRS_КатегорииМажорныхГрупп` (варианты по PRD).
- [x] Константы `MRS_БазовыйURLSimphony`, `MRS_ТаймаутЗапросовSimphony`, `MRS_ИспользоватьИнтеграциюSimphony`, `MRS_IDПользователяПоУмолчанию`.
- [x] Права/роли: доступ к объектам `MRS_*`, запуск обработок.

2) Общие модули и обработки
- [x] Общие модули: интеграция (сервер/клиент-сервер) с методами загрузки справочников и CRUD позиций; логирование интеграции; валидации.
- [x] Обработка `MRS_СинхронизацияСправочниковSimphony`: отдельные команды и «Все сразу».
- [x] Обработка `MRS_МассоваяСинхронизацияМеню`: выбранные, несинхронизированные, по владельцу.

3) Формы и пользовательские сценарии
- [x] Форма списка `MRS_Меню`: иерархия, отбор по владельцу/FamilyGroup, колонка статуса, команды пакетной синхронизации.
- [x] Форма элемента `MRS_Меню`: условное оформление для групп, автоподстановка FamilyGroup от родителя, кнопка «Синхронизировать с Simphony», статус read-only.
- [x] Валидации (без UI макетов): запрет создания позиции вне группы; обязательность полей; read-only наследуемых полей.

4) Интеграция с Simphony (высокоуровневые контракты)
- [x] Заголовки: `X-User-Id` (обяз.), `X-Correlation-Id`, `X-Request-Id` (генерация в 1С; идемпотентность/трассировка).
- [x] Endpoints справочников: `GET /referencedata/major-groups`, `GET /referencedata/family-groups`, `GET /referencedata/reportgroup`.
- [x] Endpoints меню: `PUT /menu-item` (одна позиция), `POST /menu-items` (пакет; `hierStrucId=1`).
- [x] Сопоставление полей: `stringNumberId`, `name`, `majorGroupId`, `familyGroupId`, `classItemId`, `fileNum`, `isVisible`, `hierStrucId=1`.
- [x] Формирование `stringNumberId` по правилу PRD; обеспечить уникальность в рамках `hierStrucId`.

5) Логирование и статусы
- [x] При каждом вызове REST фиксировать: операция, объект, метод, URL, запрос/ответ, код, время.
- [x] При изменении статуса обновлять регистр `MRS_СтатусыСинхронизацииМеню` с деталями ошибки и ID-ами.

6) Регламентные задания
- [x] Создать задание `MRS_СинхронизацияСправочниковИзSimphony` (1 раз/сутки) — вызывает «Синхронизировать все справочники».
- [x] Проверить обработку таймаутов/ошибок; гарантировать повтор.

7) Документация и обучение
- [ ] Обновить пользовательскую инструкцию по формам `MRS_Меню`.
- [ ] Описать процедуры синхронизации и интерпретацию статусов.
- [ ] Подготовить FAQ по типовым ошибкам и ретраям.

## Data & Integrations
- **Справочники и поля (1С типы)**
  - `Справочник.MRS_Меню` (иерархический; владелец: `СправочникСсылка.КассыККМ`)
    - Код: Строка(20)
    - Наименование: Строка(150)
    - Родитель: СправочникСсылка.MRS_Меню
    - Реквизиты:
      - ЭтоГруппа: Булево
      - Номенклатура: СправочникСсылка.Номенклатура (для позиций)
      - НомерПозиции (stringNumberId): Строка(9) — алгоритм формирования см. ниже
      - НомерВМеню (fileNum): Число(10)
      - МажорнаяГруппа: СправочникСсылка.MRS_МажорнаяГруппа
      - КлассМеню: СправочникСсылка.MRS_КлассМеню
      - СемейнаяГруппа: СправочникСсылка.MRS_СемейнаяГруппа
      - IDСтруктурыSimphony (hierStrucId): Число(1), значение всегда 1 (заполняется автоматически)
    - Бизнес-правила:
      - Для групп: обязательны `СемейнаяГруппа`, `ЭтоГруппа=Истина`.
      - Для позиций: обязательны `Номенклатура`, `МажорнаяГруппа`, `КлассМеню`; `СемейнаяГруппа` — наследуется от родителя (только просмотр).
      - Уникальность `НомерПозиции` в рамках `hierStrucId` (т.е. глобально, так как `hierStrucId=1`).
  - `Справочник.MRS_МажорнаяГруппа`
    - Код: Строка(20)
    - Наименование: Строка(100)
    - Реквизиты:
      - НомерОбъекта (objectNumber): Число(15)
      - КатегорияПоДиапазону: ПеречислениеСсылка.MRS_КатегорииМажорныхГрупп (автоопределение по диапазону)
  - `Справочник.MRS_СемейнаяГруппа` (глобальный; без владельца)
    - Код: Строка(20)
    - Наименование: Строка(100)
    - Реквизиты:
      - НомерОбъекта (objectNumber): Число(15)
  - `Справочник.MRS_КлассМеню`
    - Код: Строка(20)
    - Наименование: Строка(100)
    - Реквизиты:
      - НомерОбъекта (objectNumber): Число(15)

- **Регистры сведений**
  - `РегистрСведений.MRS_СтатусыСинхронизацииМеню` (непериодический)
    - Измерения:
      - ПозицияМеню: СправочникСсылка.MRS_Меню
    - Ресурсы:
      - Статус: ПеречислениеСсылка.MRS_СтатусыСинхронизации
      - ДатаОбновления: Дата
      - ТекстОшибки: Строка(500)
      - IDЗапроса: Строка(50)
      - IDКорреляции: Строка(50)
  - `РегистрСведений.MRS_ЛогИнтеграцииSimphony` (непериодический)
    - Измерения:
      - ДатаВремя: Дата
      - Пользователь: СправочникСсылка.Пользователи
    - Ресурсы:
      - Операция: Строка(100)
      - ОбъектСинхронизации: Строка(200)
      - HTTPМетод: Строка(10)
      - URLЗапроса: Строка(500)
      - КодОтвета: Число(5)
      - ТелоЗапроса: Строка(Неограниченная)
      - ТелоОтвета: Строка(Неограниченная)
      - ВремяВыполнения: Число(10,3)

- **Перечисления**
  - `Перечисление.MRS_СтатусыСинхронизации`: Создано, ВОбработке, Синхронизировано, Ошибка
  - `Перечисление.MRS_КатегорииМажорныхГрупп`:
    - Еда_1000000_1999999
    - АлкогольныеНапитки_2000000_2999999
    - БезалкогольныеНапитки_3000000_3999999
    - Прочее_4000000

- **Константы**
  - `Константа.MRS_БазовыйURLSimphony`: Строка(200)
  - `Константа.MRS_ТаймаутЗапросовSimphony`: Число(10), по умолчанию 30
  - `Константа.MRS_ИспользоватьИнтеграциюSimphony`: Булево
  - `Константа.MRS_IDПользователяПоУмолчанию`: Строка(50)

- **Simphony REST API (высокоуровневый контракт)**
  - Заголовки:
    - `X-User-Id` — обязателен (если не передан — используется `MRS_IDПользователяПоУмолчанию`).
    - `X-Correlation-Id`, `X-Request-Id` — генерируются в 1С; используются для трассировки и идемпотентности.
  - Endpoints:
    - Справочники:
      - `GET /referencedata/major-groups`
      - `GET /referencedata/family-groups`
      - `GET /referencedata/reportgroup` (Class Items)
    - Меню:
      - `PUT /menu-item` — создать/обновить одну позицию
      - `POST /menu-items` — пакетное создание/обновление (единый `hierStrucId=1`)
  - Сопоставление полей (1С → API):
    - `MRS_Меню.НомерПозиции` → `stringNumberId`
    - `MRS_Меню.Наименование` → `name`
    - `MRS_МажорнаяГруппа.НомерОбъекта` → `majorGroupId`
    - `MRS_СемейнаяГруппа.НомерОбъекта` → `familyGroupId`
    - `MRS_КлассМеню.НомерОбъекта` → `classItemId`
    - `MRS_Меню.НомерВМеню` → `fileNum`
    - `MRS_Меню.Видимость` → `isVisible`
    - `hierStrucId` → константное значение 1
  - Формирование `stringNumberId` (итоговая договоренность):
    - Правило: `stringNumberId = <MajorGroupID:1–2 знака> + <zero-pad до длины 6 символов> + <FamilyGroupID:3 знака>`.
    - `FamilyGroupID` дополняется нулями слева до 3 символов.
    - Пример: `MajorGroupID=2`, `FamilyGroupID=103` → `200000103`.
    - Идентификатор содержит 9 символов; уникален в рамках `hierStrucId` (фактически — глобально, т.к. `hierStrucId=1`).
  - Обработка ошибок и ретраев:
    - 2xx → статус «Синхронизировано».
    - 4xx/5xx/таймаут → статус «Ошибка», логируются код ответа и тела запроса/ответа; разрешен повтор ручной синхронизации.

- **Валидации (без UI мокапов)**
  - Позиция должна иметь родителя-Группу.
  - Обязательные поля позиции: `Номенклатура`, `МажорнаяГруппа`, `КлассМеню`; `СемейнаяГруппа` — read-only, наследуется от родителя.
  - `НомерПозиции` формируется по правилу и проверяется на уникальность.
  - Для Группы: обязателен выбор `СемейнаяГруппа`.

- **Регламентные задания**
  - `MRS_СинхронизацияСправочниковИзSimphony`: периодичность 1 раз/сутки; вызывает `СинхронизироватьВсеСправочники()`.

## Metadata
- **Справочники**
  - `MRS_Меню` (иерархический; владелец `КассыККМ`)
    - Реквизиты: ЭтоГруппа; Номенклатура; НомерПозиции (Строка(9)); НомерВМеню (Число(10)); МажорнаяГруппа; КлассМеню; СемейнаяГруппа; IDТочкиПродаж (Число(1), =1).
    - Формы: `ФормаСписка` (иерархия, отборы по владельцу/FamilyGroup, колонка статуса, команды «Создать группу», «Синхронизировать выбранные», «Синхронизировать все»); `ФормаЭлемента` (условное оформление для групп, кнопка «Синхронизировать с Simphony», поле статуса read-only, автоподстановка FamilyGroup).
  - `MRS_МажорнаяГруппа`
    - Реквизиты: НомерОбъекта (Число(15)); КатегорияПоДиапазону (Перечисление.MRS_КатегорииМажорныхГрупп).
  - `MRS_СемейнаяГруппа`
    - Реквизиты: НомерОбъекта (Число(15)).
  - `MRS_КлассМеню`
    - Реквизиты: НомерОбъекта (Число(15)).

- **Регистры сведений**
  - `MRS_СтатусыСинхронизацииМеню`: Измерение — ПозицияМеню; Ресурсы — Статус, ДатаОбновления, ТекстОшибки, IDЗапроса, IDКорреляции.
  - `MRS_ЛогИнтеграцииSimphony`: Измерения — ДатаВремя, Пользователь; Ресурсы — Операция, ОбъектСинхронизации, HTTPМетод, URLЗапроса, КодОтвета, ТелоЗапроса, ТелоОтвета, ВремяВыполнения.

- **Перечисления**
  - `MRS_СтатусыСинхронизации`: Создано; ВОбработке; Синхронизировано; Ошибка.
  - `MRS_КатегорииМажорныхГрупп`: Еда_1000000_1999999; АлкогольныеНапитки_2000000_2999999; БезалкогольныеНапитки_3000000_3999999; Прочее_4000000.

- **Константы**
  - `MRS_БазовыйURLSimphony`; `MRS_ТаймаутЗапросовSimphony`; `MRS_ИспользоватьИнтеграциюSimphony`; `MRS_IDПользователяПоУмолчанию`.

- **Общие модули**
  - `MRS_ИнтеграцияSimphonyСервер`:
    - СоздатьПозициюМеню(ЭлементМеню, ДополнительныеПараметры = Неопределено)
    - СоздатьПозицииМенюПакетно(МассивЭлементов, IDТочкиПродаж)
    - УдалитьПозициюМеню(НомерПозиции)
    - ПолучитьПозициюМеню(НомерПозиции)
    - ЗагрузитьМажорныеГруппы()
    - ЗагрузитьСемейныеГруппы()
    - ЗагрузитьКлассыМеню()
  - `MRS_ИнтеграцияSimphonyКлиентСервер`:
    - ПолучитьНастройкиИнтеграции()
    - СформироватьЗаголовкиЗапроса(IDПользователя = "")
    - ВалидироватьДанныеПозиции(ДанныеПозиции)
    - ОпределитьКатегориюПоНомеруМажорнойГруппы(НомерГруппы)
  - `MRS_ЛогированиеИнтеграцииСервер`:
    - ЗаписатьЛогИнтеграции(Операция, Объект, HTTPМетод, URL, КодОтвета, ТелоЗапроса, ТелоОтвета, ВремяВыполнения)
    - ОбновитьСтатусСинхронизации(ПозицияМеню, Статус, ТекстОшибки = "", IDЗапроса = "", IDКорреляции = "")

- **Обработки**
  - `MRS_СинхронизацияСправочниковSimphony` (серверная):
    - СинхронизироватьМажорныеГруппы()
    - СинхронизироватьСемейныеГруппы()
    - СинхронизироватьКлассыМеню()
    - СинхронизироватьВсеСправочники()
  - `MRS_МассоваяСинхронизацияМеню` (серверная):
    - СинхронизироватьВыбранныеПозиции(МассивСсылок)
    - СинхронизироватьВсеНесинхронизированные()
    - СинхронизироватьПоВладельцу(КассаККМ)

- **Права/роли**
  - Роль `HRS_ОсновнаяРоль` (или отдельная роль интеграции) — права на чтение/запись `MRS_*` объектов и запуск обработок.

- **Критерии приемки (кратко)**
  - Создание группы и позиции с валидаторами согласно правилам.
  - Успешная отправка `PUT /menu-item` и `POST /menu-items`, корректная запись статусов и логов.
  - Регламентная загрузка справочников по расписанию завершает работу без ошибок и обновляет данные.
  - `stringNumberId` формируется по согласованному правилу; уникальность обеспечена.
