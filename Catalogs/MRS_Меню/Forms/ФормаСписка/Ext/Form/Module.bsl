
// Форма списка справочника MRS_Меню
// Иерархический список позиций меню с отборами и командами синхронизации

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Установка начальных значений отборов
	УстановитьОтборыСписка();
	
	// Добавление вычисляемых полей статуса синхронизации
	ДобавитьПоляСтатусовВСписок();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ОтборВладелецПриИзменении(Элемент)
	
	УстановитьОтборыСписка();
	
КонецПроцедуры

&НаКлиенте
Процедура ОтборСемейнаяГруппаПриИзменении(Элемент)
	
	УстановитьОтборыСписка();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СоздатьГруппу(Команда)
	
	// Проверка выбора владельца
	Если НЕ ЗначениеЗаполнено(ОтборВладелец) Тогда
		
		ПоказатьПредупреждение(, "Необходимо выбрать Кассу ККМ для создания группы меню");
		Возврат;
		
	КонецЕсли;
	
	// Открытие формы создания группы
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ЗначенияЗаполнения", 
		Новый Структура("Владелец,ЭтоГруппа", ОтборВладелец, Истина));
	
	ОткрытьФорму("Справочник.MRS_Меню.ФормаОбъекта", ПараметрыФормы, ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура СинхронизироватьВыбранные(Команда)
	
	// Получение выбранных строк
	ВыбранныеСтроки = Элементы.Список.ВыделенныеСтроки;
	
	Если ВыбранныеСтроки.Количество() = 0 Тогда
		
		ПоказатьПредупреждение(, "Необходимо выбрать позиции меню для синхронизации");
		Возврат;
		
	КонецЕсли;
	
	// Синхронизация выбранных позиций
	СинхронизироватьВыбранныеНаСервере(ВыбранныеСтроки);
	
	// Обновление списка
	Элементы.Список.Обновить();
	
	ПоказатьОповещениеПользователя("Синхронизация завершена", , 
		"Синхронизировано позиций: " + Формат(ВыбранныеСтроки.Количество(), "ЧГ="));
	
КонецПроцедуры

&НаКлиенте
Процедура МассоваяСинхронизация(Команда)
	
	// Открытие обработки массовой синхронизации
	ПараметрыФормы = Новый Структура;
	
	Если ЗначениеЗаполнено(ОтборВладелец) Тогда
		
		ПараметрыФормы.Вставить("Владелец", ОтборВладелец);
		
	КонецЕсли;
	
	ОткрытьФорму("Обработка.MRS_МассоваяСинхронизацияМеню.Форма", ПараметрыФормы);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьОтборыСписка()
	
	// Получение динамического списка
	ДинамическийСписок = Список;
	
	// Очистка существующих отборов
	ДинамическийСписок.Отбор.Элементы.Очистить();
	
	// Установка отбора по владельцу
	Если ЗначениеЗаполнено(ОтборВладелец) Тогда
		
		ЭлементОтбора = ДинамическийСписок.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Владелец");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = ОтборВладелец;
		ЭлементОтбора.Использование = Истина;
		
	КонецЕсли;
	
	// Установка отбора по семейной группе
	Если ЗначениеЗаполнено(ОтборСемейнаяГруппа) Тогда
		
		ЭлементОтбора = ДинамическийСписок.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("СемейнаяГруппа");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = ОтборСемейнаяГруппа;
		ЭлементОтбора.Использование = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьПоляСтатусовВСписок()
	
	// Для отображения статуса синхронизации будет использоваться событие ПриПолученииДанных
	// или вычисляемое поле динамического списка через настройку компоновки данных
	
КонецПроцедуры

&НаСервере
Процедура СинхронизироватьВыбранныеНаСервере(Знач ВыбранныеСтроки)
	
	// Формирование массива ссылок на позиции меню
	МассивПозиций = Новый Массив;
	
	Для Каждого ВыбраннаяСтрока Из ВыбранныеСтроки Цикл
		
		// Проверка, что это не группа
		Если ТипЗнч(ВыбраннаяСтрока) = Тип("СправочникСсылка.MRS_Меню") Тогда
			
			ЭлементМеню = ВыбраннаяСтрока.ПолучитьОбъект();
			
			Если ЭлементМеню <> Неопределено И НЕ ЭлементМеню.ЭтоГруппа Тогда
				
				МассивПозиций.Добавить(ВыбраннаяСтрока);
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// Проверка наличия позиций для синхронизации
	Если МассивПозиций.Количество() = 0 Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Выбранные элементы не являются позициями меню");
		Возврат;
		
	КонецЕсли;
	
	// Установка статуса "В обработке"
	MRS_ЛогированиеИнтеграцииСервер.УстановитьСтатусВОбработке(МассивПозиций);
	
	// Вызов процедуры синхронизации
	Попытка
		
		MRS_ИнтеграцияSimphonyСервер.СоздатьПозицииМенюПакетно(МассивПозиций, 1);
		
	Исключение
		
		// Обработка ошибки
		ТекстОшибки = ОписаниеОшибки();
		
		// Установка статуса "Ошибка" для всех позиций
		Для Каждого ПозицияМеню Из МассивПозиций Цикл
			
			MRS_ЛогированиеИнтеграцииСервер.ОбновитьСтатусСинхронизации(ПозицияМеню, Перечисления.MRS_СтатусыСинхронизации.Ошибка, ТекстОшибки);
			
		КонецЦикла;
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

