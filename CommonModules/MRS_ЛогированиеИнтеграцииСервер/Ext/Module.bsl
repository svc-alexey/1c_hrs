// Общий модуль MRS_ЛогированиеИнтеграцииСервер
// Назначение: Серверные функции для логирования операций интеграции с Simphony и управления статусами синхронизации
// Содержит: запись логов интеграции, обновление статусов синхронизации позиций меню

#Область ПрограммныйИнтерфейс

#Область ЛогированиеИнтеграции

// Записывает лог операции интеграции с Simphony в регистр сведений
//
// Параметры:
//   Операция - Строка - название операции (например, "Создание позиции меню", "Загрузка мажорных групп")
//   Объект - Строка - объект синхронизации (например, "MRS_Меню", "MRS_МажорнаяГруппа")
//   HTTPМетод - Строка - HTTP метод запроса (GET, POST, PUT, DELETE)
//   URL - Строка - URL запроса к API Simphony
//   КодОтвета - Число - HTTP код ответа (200, 400, 500 и т.д.)
//   ТелоЗапроса - Строка - тело HTTP-запроса (JSON)
//   ТелоОтвета - Строка - тело HTTP-ответа (JSON)
//   ВремяВыполнения - Число - время выполнения запроса в секундах
//
Процедура ЗаписатьЛогИнтеграции(Операция, Объект, HTTPМетод, URL, КодОтвета, ТелоЗапроса, ТелоОтвета, ВремяВыполнения) Экспорт
	
	МенеджерЗаписи = РегистрыСведений.MRS_ЛогИнтеграцииSimphony.СоздатьМенеджерЗаписи();
	
	МенеджерЗаписи.ДатаВремя = ТекущаяДатаСеанса();
	
	Попытка
		МенеджерЗаписи.Пользователь = Пользователи.ТекущийПользователь();
	Исключение
		// Если модуль Пользователи недоступен, оставляем пустым
	КонецПопытки;
	МенеджерЗаписи.Операция = Операция;
	МенеджерЗаписи.ОбъектСинхронизации = Объект;
	МенеджерЗаписи.HTTPМетод = HTTPМетод;
	МенеджерЗаписи.URLЗапроса = URL;
	МенеджерЗаписи.КодОтвета = КодОтвета;
	МенеджерЗаписи.ТелоЗапроса = ТелоЗапроса;
	МенеджерЗаписи.ТелоОтвета = ТелоОтвета;
	МенеджерЗаписи.ВремяВыполнения = ВремяВыполнения;
	
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

#КонецОбласти

#Область УправлениеСтатусами

// Обновляет статус синхронизации позиции меню в регистре сведений
//
// Параметры:
//   ПозицияМеню - СправочникСсылка.MRS_Меню - ссылка на позицию меню
//   Статус - ПеречислениеСсылка.MRS_СтатусыСинхронизации - новый статус синхронизации:
//            * Создано - позиция создана, но не синхронизирована
//            * ВОбработке - синхронизация в процессе
//            * Синхронизировано - успешно синхронизировано
//            * Ошибка - ошибка при синхронизации
//   ТекстОшибки - Строка - текст ошибки (если Статус = Ошибка), по умолчанию пустая строка
//   IDЗапроса - Строка - X-Request-Id из заголовков запроса, по умолчанию пустая строка
//   IDКорреляции - Строка - X-Correlation-Id из заголовков запроса, по умолчанию пустая строка
//
Процедура ОбновитьСтатусСинхронизации(ПозицияМеню, Статус, ТекстОшибки = "", IDЗапроса = "", IDКорреляции = "") Экспорт
	
	МенеджерЗаписи = РегистрыСведений.MRS_СтатусыСинхронизацииМеню.СоздатьМенеджерЗаписи();
	
	МенеджерЗаписи.ПозицияМеню = ПозицияМеню;
	МенеджерЗаписи.Статус = Статус;
	МенеджерЗаписи.ДатаОбновления = ТекущаяДатаСеанса();
	МенеджерЗаписи.ТекстОшибки = ТекстОшибки;
	МенеджерЗаписи.IDЗапроса = IDЗапроса;
	МенеджерЗаписи.IDКорреляции = IDКорреляции;
	
	МенеджерЗаписи.Записать();
	
КонецПроцедуры

// Получает текущий статус синхронизации позиции меню
//
// Параметры:
//   ПозицияМеню - СправочникСсылка.MRS_Меню - ссылка на позицию меню
//
// Возвращаемое значение:
//   Структура - информация о статусе синхронизации:
//     * Статус - ПеречислениеСсылка.MRS_СтатусыСинхронизации - текущий статус
//     * ДатаОбновления - Дата - дата последнего обновления статуса
//     * ТекстОшибки - Строка - текст последней ошибки (если есть)
//     * IDЗапроса - Строка - ID последнего запроса
//     * IDКорреляции - Строка - ID последней корреляции
//
Функция ПолучитьСтатусСинхронизации(ПозицияМеню) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Статус", Перечисления.MRS_СтатусыСинхронизации.Создано);
	Результат.Вставить("ДатаОбновления", Дата(1, 1, 1));
	Результат.Вставить("ТекстОшибки", "");
	Результат.Вставить("IDЗапроса", "");
	Результат.Вставить("IDКорреляции", "");
	
	МенеджерЗаписи = РегистрыСведений.MRS_СтатусыСинхронизацииМеню.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ПозицияМеню = ПозицияМеню;
	МенеджерЗаписи.Прочитать();
	
	Если МенеджерЗаписи.Выбран() Тогда
		
		Результат.Статус = МенеджерЗаписи.Статус;
		Результат.ДатаОбновления = МенеджерЗаписи.ДатаОбновления;
		Результат.ТекстОшибки = МенеджерЗаписи.ТекстОшибки;
		Результат.IDЗапроса = МенеджерЗаписи.IDЗапроса;
		Результат.IDКорреляции = МенеджерЗаписи.IDКорреляции;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Устанавливает статус "ВОбработке" для массива позиций меню
//
// Параметры:
//   МассивПозиций - Массив из СправочникСсылка.MRS_Меню - массив ссылок на позиции меню
//
Процедура УстановитьСтатусВОбработке(МассивПозиций) Экспорт
	
	Для Каждого ПозицияМеню Из МассивПозиций Цикл
		
		ОбновитьСтатусСинхронизации(ПозицияМеню, Перечисления.MRS_СтатусыСинхронизации.ВОбработке);
		
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает статус "Синхронизировано" для массива позиций меню
//
// Параметры:
//   МассивПозиций - Массив из СправочникСсылка.MRS_Меню - массив ссылок на позиции меню
//   IDЗапроса - Строка - X-Request-Id из заголовков запроса
//   IDКорреляции - Строка - X-Correlation-Id из заголовков запроса
//
Процедура УстановитьСтатусСинхронизировано(МассивПозиций, IDЗапроса, IDКорреляции) Экспорт
	
	Для Каждого ПозицияМеню Из МассивПозиций Цикл
		
		ОбновитьСтатусСинхронизации(
			ПозицияМеню,
			Перечисления.MRS_СтатусыСинхронизации.Синхронизировано,
			"",
			IDЗапроса,
			IDКорреляции);
		
	КонецЦикла;
	
КонецПроцедуры

// Устанавливает статус "Ошибка" для массива позиций меню
//
// Параметры:
//   МассивПозиций - Массив из СправочникСсылка.MRS_Меню - массив ссылок на позиции меню
//   ТекстОшибки - Строка - текст ошибки
//   IDЗапроса - Строка - X-Request-Id из заголовков запроса, по умолчанию пустая строка
//   IDКорреляции - Строка - X-Correlation-Id из заголовков запроса, по умолчанию пустая строка
//
Процедура УстановитьСтатусОшибка(МассивПозиций, ТекстОшибки, IDЗапроса = "", IDКорреляции = "") Экспорт
	
	Для Каждого ПозицияМеню Из МассивПозиций Цикл
		
		ОбновитьСтатусСинхронизации(
			ПозицияМеню,
			Перечисления.MRS_СтатусыСинхронизации.Ошибка,
			ТекстОшибки,
			IDЗапроса,
			IDКорреляции);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти


